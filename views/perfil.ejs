<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheets/slidebar.css"> 
    <link rel="stylesheet" href="/stylesheets/perfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> 
    <title>Perfil - Campus Swap</title>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="perfil">
            <img src="../images/perfil.jpg" alt="Foto de perfil" class="profile-img">
            <h2><%= username %></h2>
            <p>★★★★</p>
            <p>Año</p>
        </div>
        <nav>
            <ul>
                <li><a href="/perfil" class="activo"><i class="fas fa-user"></i> Perfil</a></li>
                <li><a href="/buzon"><i class="fas fa-envelope"></i> Buzón</a></li>
                <li><a href="/listado"><i class="fas fa-list"></i> Listado</a></li>
                <li><a href="/favoritos"><i class="fas fa-heart"></i> Favoritos</a></li>
                <li><a href="/valoraciones"><i class="fas fa-star"></i> Valoraciones</a></li>
            </ul>
        </nav>
        <div class="settings">
            <a href="/ajustes">
                <img src="../images/settings-icon.svg" alt="Configuración">
            </a>
        </div>
    </div>

    <div class="main-content">
        <header>
            <input type="text" placeholder="Buscar productos..." class="barra-busqueda">
            <a href="/listado" class="seguir-comprando-boton">
                <img src="../images/Campus.png" alt="Seguir Comprando" class="logo-campus-swap">
            </a>
        </header>

        <section class="seccion-productos h2">
            <h2>Tus productos</h2>
            <div class="pestañas-productos">
                <button class="venta-vendidos-boton" onclick="mostrarProductos('en-venta')">En venta</button>
                <button class="venta-vendidos-boton" onclick="mostrarProductos('vendidos')">Vendidos</button>
            </div>
            <div id="product-list" class="product-list">
                <!-- Aquí se cargarán los productos dinámicamente -->
            </div>

            <script>
                function mostrarProductos(tipo) {
                    fetch(`/perfil/${tipo}`)
                        .then(response => response.json())
                        .then(data => {
                            const productList = document.getElementById('product-list');
                            productList.innerHTML = ''; 
                            if (data.length > 0) {
                                data.forEach(ad => {
                                    productList.innerHTML += `
                                        <div class="product-item">
                                            <div class="product">
                                                <img src="${ad.photo}" alt="">
                                                <div class="product-info">
                                                    <h3>${ad.title}</h3>
                                                    <p>
                                                        ${ad.university}
                                                        <br>Precio: ${ad.price} euros
                                                        <br>Estado: ${ad.state}
                                                    </p>
                                                </div>
                                                <div class="product-actions">
                                                    ${
                                                        ad.state !== 'Vendido'
                                                        ? `<button class="mark-sold-button" onclick="updateVendido(${ad.id_ad})">Marcar como Vendido</button>`
                                                        : ''
                                                    }
                                                    <button class="delete-button" onclick="deleteProduct(${ad.id_ad})">
                                                        <img src="../images/eliminar.png" alt="Eliminar" class="delete-icon">
                                                    </button>
                                                </div>
                                            </div>
                                        </div>`;
                                });
                            } else {
                                productList.innerHTML = '<p>No hay productos en esta categoría.</p>';
                            }
                        })
                        .catch(error => console.error('Error al cargar productos:', error));
                }

                function deleteProduct(adId) {
                    if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                        fetch(`/perfil/delete/${adId}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Producto eliminado con éxito');
                                    location.reload(); 
                                } else {
                                    alert('Error al eliminar el producto');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error al eliminar el producto');
                            });
                    }
                }

                function updateVendido(adId) {
                    if (confirm('¿Estás seguro de que quieres marcar este producto como vendido?')) {
                        fetch(`/perfil/marcar-vendido/${adId}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Producto marcado como vendido');
                                    location.reload(); 
                                } else {
                                    alert(data.message || 'Error al marcar el producto como vendido');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error al marcar el producto como vendido');
                            });
                    }
                }

                
                document.addEventListener('DOMContentLoaded', () => mostrarProductos('en-venta'));
            </script>

            <div class="botones">
                <a href="/nuevaPublicacion?from=perfil" class="nuevo-anuncio-boton">
                    <img src="../images/añadir.png" alt="Nuevo Anuncio" class="icon">
                    <span>Añadir Producto</span>
                </a>
            </div>
        </section>
    </div>
</div>

</body>
</html>