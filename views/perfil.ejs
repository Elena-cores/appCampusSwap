<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheets/slidebar.css"> 
    <link rel="stylesheet" href="/stylesheets/perfil.css"> 
    <title>Perfil - Campus Swap</title>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="perfil">
            <img src="../images/perfil.jpg" alt="Foto de perfil" class="profile-img">
            <h2><%= username %></h2>
            <p>★★★★</p>
            <p>Año</p>
        </div>
        <nav>
            <ul>
                <li><a href="/perfil">Productos</a></li>
                <li><a href="/buzon">Buzón</a></li>
                <li><a href="/favoritos">Favoritos</a></li>
                <li><a href="/valoraciones">Valoraciones</a></li>
                <li><a href="/modificar">Cambiar contraseña</a></li>
            </ul>
        </nav>
        <div class="settings">
            <img src="../images/settings-icon.svg" alt="Configuración">
        </div>
    </div>

    <div class="main-content">
        <header>
            <input type="text" placeholder="Buscar productos..." class="barra-busqueda">
            <a href="/listado" class="seguir-comprando-boton">
                <img src="../images/Campus.png" alt="Seguir Comprando" class="logo-campus-swap">
            </a>
        </header>

        <section class="seccion-productos h2">
            <h2>Tus productos</h2>
            <div class="pestañas-productos">
                <button class="venta-vendidos-boton" onclick="mostrarProductos('en-venta')">En venta</button>
                <button class="venta-vendidos-boton" onclick="mostrarProductos('vendidos')">Vendidos</button>
            </div>
            <div id="product-list" class="product-list">
                <!-- Aquí se cargarán los productos dinámicamente -->
            </div>

            <script>
                function mostrarProductos(tipo) {
                    fetch(`/perfil/${tipo}`)
                        .then(response => response.json())
                        .then(data => {
                            const productList = document.getElementById('product-list');
                            productList.innerHTML = ''; // Limpiar productos actuales
                            if (data.length > 0) {
                                data.forEach(ad => {
                                    productList.innerHTML += `
                                        <div class="product-item">
                                            <div class="product">
                                                <img src="${ad.photo}" alt="">
                                                <div class="product-info">
                                                    <h3>${ad.title}</h3>
                                                    <p>
                                                        ${ad.university}
                                                        <br>Precio: ${ad.price} euros
                                                        <br>Estado: ${ad.state}
                                                    </p>
                                                </div>
                                                <button class="delete-button" onclick="deleteProduct(${ad.id_ad})">
                                                    <img src="../images/eliminar.png" alt="Eliminar" class="delete-icon">
                                                </button>
                                            </div>
                                        </div>`;
                                });
                            } else {
                                productList.innerHTML = '<p>No hay productos en esta categoría.</p>';
                            }
                        })
                        .catch(error => console.error('Error al cargar productos:', error));
                }

                function deleteProduct(adId) {
                    if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                        fetch(`/perfil/delete/${adId}`, { method: 'DELETE' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Producto eliminado con éxito');
                                    location.reload(); // Recargar la página para reflejar los cambios
                                } else {
                                    alert('Error al eliminar el producto');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error al eliminar el producto');
                            });
                    }
                }

                // Mostrar inicialmente los productos "En venta"
                document.addEventListener('DOMContentLoaded', () => mostrarProductos('en-venta'));
            </script>

            <div class="botones">
                <a href="/nuevaPublicacion?from=perfil" class="nuevo-anuncio-boton">
                    <img src="../images/añadir.png" alt="Nuevo Anuncio" class="icon">
                    <span>Añadir Producto</span>
                </a>
            </div>
        </section>
    </div>
</div>

</body>
</html>